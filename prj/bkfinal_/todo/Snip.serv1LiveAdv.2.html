<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Chart</title>
</head>
<body>
    <div id="tv_chart_container" style="height: 100vh;"></div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/parth-royale/cdn@main/charting_library/charting_library.standalone.js"></script>

    <script>
        function isoToMs(isoString) {
            return new Date(isoString).getTime();
        }

        // Fixed mock historical data array (5 seconds apart)
        const historicalData = [
            { timestamp: '2024-02-15T10:00:00Z', open: 100, high: 102, low: 98, close: 101 },
            { timestamp: '2024-02-15T10:00:05Z', open: 101, high: 103, low: 99, close: 102 },
            { timestamp: '2024-02-15T10:00:10Z', open: 102, high: 104, low: 100, close: 103 },
            { timestamp: '2024-02-15T10:00:15Z', open: 103, high: 105, low: 101, close: 104 },
            { timestamp: '2024-02-15T10:00:20Z', open: 104, high: 106, low: 102, close: 105 },
            { timestamp: '2024-02-15T10:00:25Z', open: 105, high: 107, low: 103, close: 106 },
            { timestamp: '2024-02-15T10:00:30Z', open: 106, high: 108, low: 104, close: 107 },
            { timestamp: '2024-02-15T10:00:35Z', open: 107, high: 109, low: 105, close: 108 },
            { timestamp: '2024-02-15T10:00:40Z', open: 108, high: 110, low: 106, close: 109 },
            { timestamp: '2024-02-15T10:00:45Z', open: 109, high: 111, low: 107, close: 110 }
        ];

        // Fixed mock tick data array (continuing from historical data)
        const tickData = [
            { timestamp: '2024-02-15T10:00:50Z', price: 111 },
            { timestamp: '2024-02-15T10:00:55Z', price: 112 },
            { timestamp: '2024-02-15T10:01:00Z', price: 113 },
            { timestamp: '2024-02-15T10:01:05Z', price: 114 },
            { timestamp: '2024-02-15T10:01:10Z', price: 115 },
            { timestamp: '2024-02-15T10:01:15Z', price: 116 },
            { timestamp: '2024-02-15T10:01:20Z', price: 117 },
            { timestamp: '2024-02-15T10:01:25Z', price: 118 },
            { timestamp: '2024-02-15T10:01:30Z', price: 119 },
            { timestamp: '2024-02-15T10:01:35Z', price: 120 }
        ];

        let currentTickIndex = 0;

        const datafeed = {
            onReady: (callback) => {
                setTimeout(() => {
                    callback({
                        supported_resolutions: ['1', '5', '15', '30', '60', '1D']
                    });
                }, 0);
            },
            searchSymbols: (userInput, exchange, symbolType, onResult) => {
                onResult([]);
            },
            resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback) => {
                setTimeout(() => {
                    onSymbolResolvedCallback({
                        name: symbolName,
                        description: symbolName,
                        type: 'crypto',
                        session: '24x7',
                        timezone: 'Etc/UTC',
                        exchange: 'Crypto',
                        minmov: 1,
                        pricescale: 100,
                        has_intraday: true,
                        has_daily: true,
                        has_weekly_and_monthly: false,
                        supported_resolutions: ['1', '5', '15', '30', '60', '1D']
                    });
                }, 0);
            },
            getBars: (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) => {
                try {
                    const { from, to } = periodParams;
                    const fromMs = from * 1000;
                    const toMs = to * 1000;

                    const filteredBars = historicalData
                        .filter(item => {
                            const itemTime = isoToMs(item.timestamp);
                            return itemTime >= fromMs && itemTime <= toMs;
                        })
                        .map(item => ({
                            time: isoToMs(item.timestamp),
                            open: item.open,
                            high: item.high,
                            low: item.low,
                            close: item.close,
                            volume: 1000
                        }));

                    onHistoryCallback(filteredBars, {
                        noData: filteredBars.length === 0
                    });
                } catch (error) {
                    console.error('Error in getBars:', error);
                    onErrorCallback(error);
                }
            },
            subscribeBars: (symbolInfo, resolution, onRealtimeCallback, subscriberUID) => {
                const intervalId = setInterval(() => {
                    if (currentTickIndex >= tickData.length) {
                        currentTickIndex = 0;
                    }
                    
                    const tick = tickData[currentTickIndex];
                    onRealtimeCallback({
                        time: isoToMs(tick.timestamp),
                        open: tick.price,
                        high: tick.price + 1,
                        low: tick.price - 1,
                        close: tick.price,
                        volume: 1000
                    });
                    
                    currentTickIndex++;
                }, 1000);

                return intervalId;
            },
            unsubscribeBars: (subscriberUID) => {
                clearInterval(subscriberUID);
            }
        };

        const widgetOptions = {
            symbol: 'BTCUSDT',
            interval: '1',
            container: 'tv_chart_container',
            library_path: 'https://cdn.jsdelivr.net/gh/parth-royale/cdn@main/charting_library/',
            locale: 'en',
            datafeed: datafeed,
            enabled_features: [],
            disabled_features: [
                'use_localstorage_for_settings',
                'study_templates',
                'save_chart_properties_to_local_storage'
            ],
            fullscreen: true,
            autosize: true,
            theme: 'light'
        };

        const tvWidget = new TradingView.widget(widgetOptions);
    </script>
</body>
</html>